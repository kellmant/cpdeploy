#!/bin/bash
if [ -z "$1" ]
  then
echo ""
    echo "give a name for the central VPN gateway $0 <name>"
    echo "This will create a group 'SecureVPC' to use in rules"
echo ""
exit
fi

source VAR
vpcid=$(awk '/VpcId/ {print $2;}' ${gwout}/${1}/vpc | sed 's/"//g' | sed 's/,//g')
subnetid0=$(awk '/SubnetId/ {print $2;}' ${gwout}/${1}/subnet0 | sed 's/"//g' | sed 's/,//g')
IP=$(awk '/PublicIpAddress/ {print $2;}' ${gwout}/${1}/pubip | sed 's/"//g' | sed 's/,//g')
subid=(`cat ${gwout}/${1}/id`)
baseurl=https://$host/web_api
curl_cmd="curl --silent --insecure -X POST"

SID=`${curl_cmd} -H "Content-Type: application/json" -d @- $baseurl/login <<. | awk -F\" '/sid/ {print $4}'
{
  "user":"$username" ,
  "password":"$password" ,
  "session-name":"init_prep"
}
.`

# Login complete, add objects, rules and such here.
################################################################################################

sleep 5

echo "adding gw-${1} with ip $IP"


${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-simple-gateway <<.
{
  "name" : "gw-${1}",
  "color" : "RED",
  "ipv4-address" : "$IP",
  "version" : "R77.30",
  "one-time-password" : "$otp",
  "firewall" : "true",
  "vpn" : "true",
  "application-control" : "true",
  "url-filtering" : "true",
  "ips" : "true",
  "anti-bot" : "true",
  "anti-virus" : "true",
  "threat-emulation" : "true",
  "interfaces" : [ {
    "name" : "eth0",
    "ipv4-address" : "10.0.${subid}.254",
    "ipv4-network-mask" : "255.255.255.128",
    "ipv4-mask-length" : "25",
    "topology" : "external",
    "anti-spoofing" : "true",
    "anti-spoofing-settings" : {
      "action" : "prevent"
    },
    "security-zone" : "false"
  }, {
    "name" : "eth1",
    "ipv4-address" : "10.0.${subid}.10",
    "ipv4-network-mask" : "255.255.255.128",
    "ipv4-mask-length" : "25",
    "topology" : "internal",
    "topology-settings" : {
      "ip-address-behind-this-interface" : "network defined by the interface ip and net mask",
      "interface-leads-to-dmz" : "false"
    },
    "anti-spoofing" : "true",
    "anti-spoofing-settings" : {
      "action" : "prevent"
    },
    "security-zone" : "false"
  } ]
}
.

sleep 8

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-vpn-community-star <<.
{
  "name" : "SecureVPC-VPN",
  "center-gateways" : "gw-${1}"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-group <<.
{
  "name" : "SecureVPC"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-host <<.
{
  "name" : "$admin_host",
  "ip-address" : "$admin_ip"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/set-access-rule <<.
{
  "layer" : "Network",
  "name" : "Cleanup rule",
  "track" : "Full Log"
}
.
 
sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-access-rule <<.
{
  "layer" : "Network",
  "position" : "top",
  "name" : "Debug Access",
  "source" : "$admin_host",
  "service" : "ssh_version_2",
  "action" : "Accept",
  "track" : "Full Log",
  "install-on" : "Policy Targets"
}
.


sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-access-section <<.
{
  "layer" : "Network",
  "position" : "top",
  "name" : "Kill em all"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-network <<.
{
  "name" : "${1}-${vpcid}",
  "subnet" : "10.0.${subid}.0",
  "subnet-mask" : "255.255.255.0"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-network <<.
{
  "name" : "${1}-${subnetid0}",
  "subnet" : "10.0.${subid}.0",
  "subnet-mask" : "255.255.255.128"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-access-rule <<.
{
  "layer" : "Network",
  "position" : "top",
  "name" : "VPC Access",
  "source" : "${1}-${subnetid0}",
  "destination" : "SecureVPC",
  "service" : "Any",
  "vpn" : "SecureVPC-VPN",
  "action" : "Accept",
  "track" : "Full Log",
  "install-on" : "Policy Targets"
}
.

sleep 5

${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d @- $baseurl/add-access-section <<.
{
  "layer" : "Network",
  "position" : "top",
  "name" : "Secure VPC Access"
}
.

sleep 5

################################################################################################
# Publish and get out of here
${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d "{}" $baseurl/publish

sleep 5

#Logout
${curl_cmd} -H "Content-Type: application/json" -H "X-chkp-sid: $SID" -d "{}" $baseurl/logout

rm -rf ${out}/${1}.nogw

exit 0
